<app-admin-navbar></app-admin-navbar>
<div class="notification-container">
  <!-- En-tête -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h4 mb-0">
      <i class="bi bi-bell me-2"></i>Tableau de bord des notifications
    </h2>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary" (click)="markAllAsRead()" [disabled]="unreadCount === 0">
        <i class="bi bi-check-all me-1"></i>Tout marquer comme lu
      </button>
      <button class="btn btn-primary" (click)="loadData()">
        <i class="bi bi-arrow-clockwise me-1"></i>Actualiser
      </button>
    </div>
  </div>
  
  <!-- Compteurs -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card border-primary">
        <div class="card-body">
          <h5 class="card-title">Notifications non lues</h5>
          <h2 class="text-primary">{{ unreadCount }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-warning">
        <div class="card-body">
          <h5 class="card-title">Signalements en attente</h5>
          <h2 class="text-warning">{{ signalementsRecuCount }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-info">
        <div class="card-body">
          <h5 class="card-title">Signalements en cours</h5>
          <h2 class="text-info">{{ signalementsEnTraitementCount }}</h2>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Filtres -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filtres</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <label class="form-label">Type de notification</label>
          <select class="form-select" [(ngModel)]="filterNotificationType">
            <option value="">Tous</option>
            <option value="SIGNALEMENT">Signalements</option>
            <option value="INTERVENTION">Interventions</option>
            <option value="SYSTEME">Système</option>
            <option value="ALERTE">Alertes</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Statut signalement</label>
          <select class="form-select" [(ngModel)]="filterSignalementStatut">
            <option value="">Tous</option>
            <option value="RECU">Reçu</option>
            <option value="EN_TRAITEMENT">En traitement</option>
            <option value="RESOLU">Résolu</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Urgence signalement</label>
          <select class="form-select" [(ngModel)]="filterSignalementUrgence">
            <option value="">Tous</option>
            <option value="HIGH">Haute</option>
            <option value="MEDIUM">Moyenne</option>
            <option value="LOW">Basse</option>
          </select>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-12">
          <button class="btn btn-primary me-2" (click)="applyFilters()">
            <i class="bi bi-filter me-1"></i>Appliquer
          </button>
          <button class="btn btn-outline-secondary" (click)="clearFilters()">
            <i class="bi bi-x-circle me-1"></i>Effacer
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Onglets -->
  <div class="row">
    <div class="col-12">
      <ul class="nav nav-tabs" id="notificationTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="notif-tab" data-bs-toggle="tab" 
                  data-bs-target="#notif" type="button" role="tab">
            <i class="bi bi-bell me-1"></i>Notifications
            <span class="badge bg-danger ms-1" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="signal-tab" data-bs-toggle="tab" 
                  data-bs-target="#signal" type="button" role="tab">
            <i class="bi bi-exclamation-triangle me-1"></i>Signalements
            <span class="badge bg-warning ms-1">{{ signalements.length }}</span>
          </button>
        </li>
      </ul>
      
      <div class="tab-content mt-3" id="notificationTabContent">
        <!-- Onglet Notifications -->
        <div class="tab-pane fade show active" id="notif" role="tabpanel">
          <div class="list-group">
            <div *ngFor="let notif of paginatedNotifications" 
                 class="list-group-item list-group-item-action"
                 [class.list-group-item-light]="!notif.statutLecture"
                 (click)="markAsRead(notif)">
              <div class="d-flex w-100 justify-content-between">
                <div>
                  <h6 class="mb-1">
                    <span *ngIf="!notif.statutLecture" class="badge bg-primary me-2">Nouveau</span>
                    {{ notif.message }}
                  </h6>
                  <small class="text-muted">
                    <i class="bi bi-clock me-1"></i>
                    {{ notif.dateCreation | date:'dd/MM/yyyy HH:mm' }}
                  </small>
                </div>
                <small>
                  <span class="badge bg-secondary">{{ notif.typeNotification }}</span>
                </small>
              </div>
            </div>
            
            <!-- Pagination Notifications -->
            <nav *ngIf="totalPagesNotif() > 1" class="mt-3">
              <ul class="pagination justify-content-center">
                <li class="page-item" [class.disabled]="currentPageNotif === 1">
                  <a class="page-link" (click)="goToPageNotif(currentPageNotif - 1)">Précédent</a>
                </li>
                <li *ngFor="let page of [].constructor(totalPagesNotif()); let i = index" 
                    class="page-item" [class.active]="currentPageNotif === i + 1">
                  <a class="page-link" (click)="goToPageNotif(i + 1)">{{ i + 1 }}</a>
                </li>
                <li class="page-item" [class.disabled]="currentPageNotif === totalPagesNotif()">
                  <a class="page-link" (click)="goToPageNotif(currentPageNotif + 1)">Suivant</a>
                </li>
              </ul>
            </nav>
            
            <!-- Aucune notification -->
            <div *ngIf="notifications.length === 0" class="text-center py-5">
              <i class="bi bi-bell-slash display-4 text-muted mb-3"></i>
              <h5>Aucune notification</h5>
              <p class="text-muted">Tout est à jour !</p>
            </div>
          </div>
        </div>
        
        <!-- Onglet Signalements -->
        <div class="tab-pane fade" id="signal" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Titre</th>
                  <th>Statut</th>
                  <th>Urgence</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let signal of paginatedSignalements">
                  <td>
                    <span class="fs-5">{{ getTypeIcon(signal.type) }}</span>
                    <small class="d-block">{{ signal.type }}</small>
                  </td>
                  <td>
                    <strong>{{ signal.titre }}</strong>
                    <small class="d-block text-muted">{{ signal.adresse }}</small>
                  </td>
                  <td>
                    <span [class]="getStatutClass(signal.statut)">
                      {{ signal.statut }}
                    </span>
                  </td>
                  <td>
                    <span [class]="getUrgenceClass(signal.urgence)">
                      {{ signal.urgence }}
                    </span>
                  </td>
                  <td>{{ signal.dateCreation | date:'dd/MM/yy HH:mm' }}</td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-info" 
                              title="Voir détails">
                        <i class="bi bi-eye"></i>
                      </button>
                      <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" 
                                type="button" data-bs-toggle="dropdown">
                          Statut
                        </button>
                        <ul class="dropdown-menu">
                          <li>
                            <a class="dropdown-item" 
                               (click)="updateSignalementStatut(signal.id!, 'RECU')">
                              Marquer comme Reçu
                            </a>
                          </li>
                          <li>
                            <a class="dropdown-item" 
                               (click)="updateSignalementStatut(signal.id!, 'EN_TRAITEMENT')">
                              Marquer comme En traitement
                            </a>
                          </li>
                          <li>
                            <a class="dropdown-item" 
                               (click)="updateSignalementStatut(signal.id!, 'RESOLU')">
                              Marquer comme Résolu
                            </a>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination Signalements -->
          <nav *ngIf="totalPagesSignal() > 1" class="mt-3">
            <ul class="pagination justify-content-center">
              <li class="page-item" [class.disabled]="currentPageSignal === 1">
                <a class="page-link" (click)="goToPageSignal(currentPageSignal - 1)">Précédent</a>
              </li>
              <li *ngFor="let page of [].constructor(totalPagesSignal()); let i = index" 
                  class="page-item" [class.active]="currentPageSignal === i + 1">
                <a class="page-link" (click)="goToPageSignal(i + 1)">{{ i + 1 }}</a>
              </li>
              <li class="page-item" [class.disabled]="currentPageSignal === totalPagesSignal()">
                <a class="page-link" (click)="goToPageSignal(currentPageSignal + 1)">Suivant</a>
              </li>
            </ul>
          </nav>
          
          <!-- Aucun signalement -->
          <div *ngIf="signalements.length === 0" class="text-center py-5">
            <i class="bi bi-check-circle display-4 text-success mb-3"></i>
            <h5>Aucun signalement</h5>
            <p class="text-muted">Tous les signalements sont traités !</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>